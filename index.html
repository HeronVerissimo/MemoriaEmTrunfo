<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Museus Aumentados</title>

  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

  <style>
    /* ===== Modal (Jacinto) ===== */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(8px);
      z-index:9999;
    }
    .modal-box{
      background:rgba(255,255,255,.96);
      width:min(680px, 92vw);
      max-height:86vh;
      margin:7vh auto;
      border-radius:16px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      box-shadow:0 20px 45px rgba(0,0,0,.35);
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      padding:14px 16px;
      border-bottom:1px solid rgba(0,0,0,.1);
    }
    .kicker{ font-size:12px; opacity:.75; margin-bottom:4px; }
    .title{ margin:0; font-size:18px; line-height:1.15; }
    .close-btn{
      border:0;
      background:none;
      font-size:20px;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
    }
    .close-btn:active{ background:rgba(0,0,0,.06); }

    .modal-body{
      padding:14px 16px;
      overflow:auto;
      font-size:14px;
      line-height:1.45;
    }
    .hint{
      background:rgba(0,0,0,.05);
      border:1px solid rgba(0,0,0,.06);
      padding:10px 12px;
      border-radius:12px;
      margin-bottom:12px;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .btn{
      border:0;
      border-radius:12px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:700;
    }
    .btn-primary{ background:#111; color:#fff; }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .resultado{
      border-top:1px solid rgba(0,0,0,.08);
      padding-top:12px;
    }
    .hidden{ display:none; }

    .chip{
      display:inline-block;
      font-size:12px;
      font-weight:800;
      letter-spacing:.4px;
      padding:6px 10px;
      border-radius:999px;
      margin-bottom:8px;
      border:1px solid rgba(0,0,0,.1);
    }
    .chip.sorte{ background:rgba(34,197,94,.12); }
    .chip.reves{ background:rgba(239,68,68,.12); }
    .chip.aleatorio{ background:rgba(59,130,246,.12); }

    .res-titulo{ margin:0 0 6px; font-size:16px; }
    .res-texto{ margin:0 0 10px; opacity:.95; }

    .rules{
      background:rgba(0,0,0,.04);
      border:1px solid rgba(0,0,0,.06);
      border-radius:12px;
      padding:10px 12px;
    }
    .rules-title{
      font-size:12px;
      font-weight:900;
      opacity:.75;
      margin-bottom:6px;
    }
    .rules-list{ margin:0; padding-left:18px; }

    .modal-footer{
      padding:10px 16px;
      border-top:1px solid rgba(0,0,0,.1);
      font-size:12px;
      opacity:.8;
    }
  </style>
</head>

<body style="margin:0; overflow:hidden;">

  <!-- MODAL (apenas Jacinto) -->
  <div id="modalJacinto" class="modal" role="dialog" aria-modal="true" aria-labelledby="jacintoTitle">
    <div class="modal-box">
      <div class="modal-header">
        <div>
          <div class="kicker">Espírito de Jacinto de Sousa</div>
          <h2 class="title" id="jacintoTitle">Interferência: Sorte ou Revés</h2>
        </div>
        <button id="fecharJacinto" class="close-btn" aria-label="Fechar">✕</button>
      </div>

      <div class="modal-body">
        <div class="hint">
          O epírito de Jacinto de Sousa apareceu, agora revele sua interferência!!!
        </div>

        <div class="actions">
          <button id="btnRevelar" class="btn btn-primary">Revelar Interferência</button>
        </div>

        <div id="resultado" class="resultado hidden">
          <div class="chip" id="chipTipo">TIPO</div>
          <h3 id="resTitulo" class="res-titulo">Título</h3>
          <p id="resTexto" class="res-texto">Descrição</p>

          <div class="rules">
            <div class="rules-title">Como aplicar no jogo</div>
            <ul id="resRegras" class="rules-list"></ul>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        Feche o modal para retomar a câmera.
      </div>
    </div>
  </div>

  <!-- CENA AR -->
  <a-scene id="scene" embedded arjs="sourceType: webcam; debugUIEnabled: false;">
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // =========================
    // 1) MARKERS (lista grande)
    // =========================

    const todosCodigos = [
      "1A","1B","1C","1D",
      "2A","2B","2C","2D",
      "3A","3B","3C","3D",
      "4A","4B","4C","4D",
      "5A","5B","5C","5D",
      "6A","6B","6C","6D",
      "7A","7B","7C","7D",
      "8A","8B","8C","8D", "trunfo"
    ];

    // Estes têm imagem própria; o resto usa emProducao.png
    const codigosComImagem = [
      "1C","1D","2A","2B","3B","3C","3D",
      "4A","5B","6A","6B","7A","7B","7D",
      "8A","8B","8C","8D"
    ];

    // JPGs (inclui 7D como você pediu)
    const jpgs = ["3D", "6A", "7A", "7D", "8A", "8D"];

    function srcImagemParaCodigo(codigo) {
      if (!codigosComImagem.includes(codigo)) return "assets/img/emProducao.png";
      const ext = jpgs.includes(codigo) ? "jpg" : "png";
      return `assets/img/${codigo}.${ext}`;
    }

    const sceneEl = document.querySelector("a-scene");

    // Gera todos os markers padrão (SEM modal)
    todosCodigos.forEach(codigo => {
      const marker = document.createElement("a-marker");
      marker.setAttribute("type", "pattern");
      marker.setAttribute("url", `patts/pattern-${codigo}.patt`);

      const image = document.createElement("a-image");
      image.setAttribute("src", srcImagemParaCodigo(codigo));
      image.setAttribute("width", "3");
      image.setAttribute("height", "3");
      image.setAttribute("rotation", "-90 0 0");
      image.setAttribute("position", "0 0 0");

      marker.appendChild(image);
      sceneEl.appendChild(marker);
    });

    // Marker Jacinto (COM modal)
    const markerJacinto = document.createElement("a-marker");
    markerJacinto.setAttribute("id", "marker-jacinto");
    markerJacinto.setAttribute("type", "pattern");
    markerJacinto.setAttribute("url", "patts/pattern-jacinto.patt");

    const imgJacinto = document.createElement("a-image");
    imgJacinto.setAttribute("src", "assets/img/layout_verso.png");
    imgJacinto.setAttribute("width", "3");
    imgJacinto.setAttribute("height", "3");
    imgJacinto.setAttribute("rotation", "-90 0 0");
    imgJacinto.setAttribute("position", "0 0 0");

    markerJacinto.appendChild(imgJacinto);
    sceneEl.appendChild(markerJacinto);

    // =========================
    // 2) MODAL + ALEATORIEDADE
    // =========================

    const scene = document.getElementById("scene");

    const modal = document.getElementById("modalJacinto");
    const btnClose = document.getElementById("fecharJacinto");
    const btnRevelar = document.getElementById("btnRevelar");

    const resultadoBox = document.getElementById("resultado");
    const chipTipo = document.getElementById("chipTipo");
    const resTitulo = document.getElementById("resTitulo");
    const resTexto  = document.getElementById("resTexto");
    const resRegras = document.getElementById("resRegras");

    let modalAberto = false;
    let resultadoTravado = false;

    // RNG melhor que Math.random()
    function randInt(maxExclusive) {
      const arr = new Uint32Array(1);
      crypto.getRandomValues(arr);
      return arr[0] % maxExclusive;
    }

    // Probabilidades IGUAIS (1/3 cada) entre: Sorte, Revés, Aleatoriedade
    const efeitos = {
      sorte: [
        {
          titulo: "Vitória em Dobro",
          texto: "A vitória é abençoada. O vencedor ganha uma carta extra da mão de cada um dos outros jogadores.",
          regras: [
            "Cada jogador entrega 1 carta da própria mão ao vencedor.",
            "Se algum jogador não tiver cartas na mão, ele não entrega nada."
          ]
        },
        {
          titulo: "Previsão do Futuro",
          texto: "O vencedor tem um vislumbre do destino e pode espiar o topo do monte de metade dos jogadores (arredondando para baixo).",
          regras: [
            "Calcule metade do número de jogadores e arredonde para baixo.",
            "Escolha esse número de jogadores e veja a carta do topo do monte de cada um.",
            "Depois devolva cada carta exatamente ao topo do respectivo monte."
          ]
        }
      ],
      reves: [
        {
          titulo: "Vitória Anulada",
          texto: "O espírito rejeita a última vitória. Ela é cancelada e as cartas retornam aos seus montes.",
          regras: [
            "Desfaça o resultado da última rodada.",
            "As cartas que mudaram de dono voltam aos seus montes originais (como estavam antes da rodada)."
          ]
        },
        {
          titulo: "Atributo Maculado",
          texto: "Na próxima rodada, o vencedor não pode escolher o mesmo atributo usado para vencer a rodada anterior.",
          regras: [
            "Marque qual atributo foi usado na última vitória.",
            "Na próxima rodada, se o mesmo jogador vencer novamente, ele não pode escolher aquele atributo.",
            "Se outro jogador vencer, a regra não se aplica."
          ]
        }
      ],
      aleatorio: [
        {
          titulo: "Troca de Domínio",
          texto: "O destino gira a mesa: todos passam a carta do topo de seus montes ao jogador à esquerda.",
          regras: [
            "Cada jogador pega a carta do topo do próprio monte.",
            "Cada jogador pega a carta em sua mão e a entrega para o jogador à esquerda.",
            "As cartas recebidas viram o novo topo do monte de cada jogador."
          ]
        }
      ]
    };

    function renderResultado(tipo, item) {
      // chip + cor
      if (tipo === "sorte") {
        chipTipo.textContent = "SORTE";
        chipTipo.className = "chip sorte";
      } else if (tipo === "reves") {
        chipTipo.textContent = "REVÉS";
        chipTipo.className = "chip reves";
      } else {
        chipTipo.textContent = "ALEATORIEDADE";
        chipTipo.className = "chip aleatorio";
      }

      resTitulo.textContent = item.titulo;
      resTexto.textContent = item.texto;

      // lista de regras
      resRegras.innerHTML = "";
      item.regras.forEach(r => {
        const li = document.createElement("li");
        li.textContent = r;
        resRegras.appendChild(li);
      });

      resultadoBox.classList.remove("hidden");
    }

    function sortearInterferenciaUmaVez() {
      // 0: sorte, 1: reves, 2: aleatorio (igual)
      const tipoIndex = randInt(3);
      const tipo = (tipoIndex === 0) ? "sorte" : (tipoIndex === 1) ? "reves" : "aleatorio";

      const lista = efeitos[tipo];
      const item = lista[randInt(lista.length)];

      renderResultado(tipo, item);

      resultadoTravado = true;
      btnRevelar.disabled = true; // sem "sortear novamente"
    }

    function abrirModal() {
      modal.style.display = "block";
      modalAberto = true;

      // pausa a câmera/cena
      scene.pause();

      // reset visual do modal (cada abertura começa “limpo”)
      resultadoBox.classList.add("hidden");
      chipTipo.textContent = "TIPO";
      chipTipo.className = "chip";
      resTitulo.textContent = "";
      resTexto.textContent = "";
      resRegras.innerHTML = "";

      resultadoTravado = false;
      btnRevelar.disabled = false;
    }

    function fecharModal() {
      modal.style.display = "none";
      modalAberto = false;

      // retoma a câmera/cena
      scene.play();
    }

    // abre ao detectar Jacinto (não fecha com markerLost)
    markerJacinto.addEventListener("markerFound", () => {
      if (modalAberto) return;
      abrirModal();
    });

    btnRevelar.addEventListener("click", () => {
      if (resultadoTravado) return;
      sortearInterferenciaUmaVez();
    });

    btnClose.addEventListener("click", fecharModal);

    // opcional: clicar fora do box fecha
    modal.addEventListener("click", (e) => {
      if (e.target === modal) fecharModal();
    });
  </script>
</body>
</html>
